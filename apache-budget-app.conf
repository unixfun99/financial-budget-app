# Apache configuration for Financial Budget Application
# Location: /etc/httpd/conf.d/budget-app.conf
# After installation, restart Apache: sudo systemctl restart httpd

# Enable required modules first:
# sudo a2enmod proxy proxy_http rewrite ssl

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    
    # Redirect all HTTP traffic to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
    
    # Let's Encrypt verification
    DocumentRoot /var/www/financial-budget-app/public
    
    ErrorLog /var/log/httpd/budget-app-http-error.log
    CustomLog /var/log/httpd/budget-app-http-access.log combined
</VirtualHost>

# Main HTTPS configuration
<VirtualHost *:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    DocumentRoot /var/www/financial-budget-app/public
    
    # SSL/TLS Configuration
    SSLEngine On
    SSLCertificateFile /etc/letsencrypt/live/yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/yourdomain.com/privkey.pem
    SSLCertificateChainFile /etc/letsencrypt/live/yourdomain.com/chain.pem
    
    # Modern SSL configuration - disable old protocols
    SSLProtocol -all +TLSv1.2 +TLSv1.3
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
    SSLHonorCipherOrder off
    SSLPreferServerCipherOrder off
    
    # HSTS - Strict Transport Security
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Enable compression for static assets
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
        # Exclude images and other binary data
        SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|ico|eot|woff|woff2|ttf|svg)$" no-gzip
    </IfModule>
    
    # Cache control for static assets
    <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Don't cache HTML
    <FilesMatch "\.html?$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Expires "0"
    </FilesMatch>
    
    # Proxy configuration - Send requests to Node.js application on port 5000
    ProxyPreserveHost On
    ProxyRequests Off
    
    # Main application proxy
    <Proxy http://127.0.0.1:5000>
        Order allow,deny
        Allow from all
    </Proxy>
    
    # HTTP proxy settings
    ProxyPass / http://127.0.0.1:5000/ nocanon
    ProxyPassReverse / http://127.0.0.1:5000/
    
    # Timeout settings (30 minutes for long-running requests)
    ProxyTimeout 1800
    TimeOut 1800
    
    # WebSocket support
    # Make sure mod_proxy_wstunnel is loaded
    <IfModule mod_proxy_wstunnel.c>
        ProxyPass /ws/ ws://127.0.0.1:5000/ws/ nocanon
        ProxyPassReverse /ws/ ws://127.0.0.1:5000/ws/
    </IfModule>
    
    # Logging
    ErrorLog /var/log/httpd/budget-app-ssl-error.log
    CustomLog /var/log/httpd/budget-app-ssl-access.log combined
    
    # Enable rewrite for single-page application
    <IfModule mod_rewrite.c>
        RewriteEngine On
        # Except for actual files and directories
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        # Rewrite to index.html for SPA routing (handled by Node.js proxy)
        # RewriteRule ^ / [QSA]
    </IfModule>
</VirtualHost>

# Optional: Rate limiting per IP (to prevent DDoS)
<IfModule mod_ratelimit.c>
    # Limit to 1MB/s per IP
    <Location />
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 1000
    </Location>
</IfModule>

# Optional: Module prerequisites
# Ensure these modules are loaded in /etc/httpd/conf.modules.d/00-*.conf
# LoadModule proxy_module modules/mod_proxy.so
# LoadModule proxy_http_module modules/mod_proxy_http.so
# LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
# LoadModule rewrite_module modules/mod_rewrite.so
# LoadModule headers_module modules/mod_headers.so
# LoadModule deflate_module modules/mod_deflate.so
# LoadModule ssl_module modules/mod_ssl.so
# LoadModule ratelimit_module modules/mod_ratelimit.so
